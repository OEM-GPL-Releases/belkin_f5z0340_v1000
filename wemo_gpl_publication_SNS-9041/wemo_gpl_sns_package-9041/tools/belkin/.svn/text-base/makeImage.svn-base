#! /bin/sh

WORKING_DIR=$1
KERNEL_NAME=$2
FS_NAME=$3
SQUASH_NAME=$4
OUTPUT_NAME=$5
SKU_STRING=$6

# Belkin Header _start
#----------------------------
# FIRST 16 BYTES : MAGIC_STRING(9), HEADER_VERSION(2), HEADER_LENGTH(5)
MAGIC_STRING=".BELKIN.."
HEADER_VERSION="01"
HEADER_LENGTH="64"
( printf "%9s%2s%05X" $MAGIC_STRING $HEADER_VERSION $HEADER_LENGTH ) > $WORKING_DIR/hdr.1

# SECOND 16 BYTES : SKU_STRING_LENGTH(1), SKU_STRING(15)
SKU_STRING_LENGTH=`echo $SKU_STRING | wc -c`
( printf "%01X%0`expr "$SKU_STRING_LENGTH" - 1`s%0`expr 15 - "$SKU_STRING_LENGTH" + 1`s" $SKU_STRING_LENGTH $SKU_STRING $SKU_EMPTY) > $WORKING_DIR/hdr.2

# THIRD 16 BYTES : CHKSUM(8), SGIN_TYPE(1), SIGNER(7)
CHKSUM=`cksum $SQUASH_NAME | awk '{print $1}'`
SGIN_TYPE="0"
SIGNER=""
( printf "%08X%01s%07s" $CHKSUM $SGIN_TYPE $SIGNER ) > $WORKING_DIR/hdr.3

# FOURTH 16 BYTES : "K"(1), KERNEL_OFFSET(7), "F"(1), FS_OFFSET(7)
KERNEL_OFFSET="0"
KERNEL_SIZE=`stat -c%s "$KERNEL_NAME"`
FS_OFFSET=`expr "$KERNEL_OFFSET" + "$KERNEL_SIZE"`
FS_SIZE=`stat -c%s "$FS_NAME"`
( printf "K%07XF%07X" $KERNEL_OFFSET $FS_OFFSET ) > $WORKING_DIR/hdr.4
#----------------------------
# Belkin Header _end

HDR_NAME="hdr.belkin"
MAX_HEADER_LENGTH="256"
PAD_SIZE=`expr "$MAX_HEADER_LENGTH" - "$HEADER_LENGTH"`
( cat $WORKING_DIR/hdr.1 ; cat $WORKING_DIR/hdr.2 ; cat $WORKING_DIR/hdr.3 ; cat $WORKING_DIR/hdr.4 ; dd if=/dev/zero bs=$PAD_SIZE count=1) > $WORKING_DIR/$HDR_NAME

( cat $SQUASH_NAME ; cat $WORKING_DIR/$HDR_NAME ) > $OUTPUT_NAME

